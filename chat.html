<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agora Video Call</title>
    <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N.js"></script>
</head>
<body>
    <h2>Agora Video Call</h2>

    <div>
        <h3>Your Video</h3>
        <div id="local-video" style="width: 300px; height: 200px; background: black;"></div>
    </div>

    <div>
        <h3>Remote Users</h3>
        <div id="remote-video-container" style="display: flex; flex-wrap: wrap;"></div>
    </div>

    <button id="startBtn" onclick="startCall()">Start Call</button>

    <script>
        const APP_ID = "33d99b3ec6ec4c36a90a3dac6abce480";
        const TOKEN = "007eJxTYCjZWPl8G3PEvNlXkxUlFgSvKza4+Csr+ssqjrOsYv3urxQUGIyNUywtk4xTk81Sk02Sjc0SLQ0SjVMSk80Sk5JTTSwMbka9TG8IZGSI1b3GyMgAgSA+K0NQYkZpDgMDAJ6OIMo=";
        const CHANNEL_NAME = "Rahul";

        const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

        let localTracks = {
            videoTrack: null,
            audioTrack: null
        };
        let remoteUsers = {};

        async function startCall() {
            try {
                document.getElementById("startBtn").disabled = true;

                // ✅ Join the channel
                const uid = await client.join(APP_ID, CHANNEL_NAME, TOKEN, null);

                // ✅ Request Camera & Mic Permissions
                [localTracks.audioTrack, localTracks.videoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();

                // ✅ Play Local Video
                localTracks.videoTrack.play("local-video");

                // ✅ Publish to Channel
                await client.publish([localTracks.audioTrack, localTracks.videoTrack]);

                console.log("Local stream published.");

                // ✅ Handle Remote Users Joining
                client.on("user-published", async (user, mediaType) => {
                    await client.subscribe(user, mediaType);
                    console.log("User Published:", user.uid);

                    if (mediaType === "video") {
                        addRemoteUser(user);
                    }

                    if (mediaType === "audio") {
                        user.audioTrack.play();
                    }
                });

                // ✅ Handle User Leaving
                client.on("user-unpublished", (user) => {
                    console.log("User Left:", user.uid);
                    removeRemoteUser(user.uid);
                });

            } catch (error) {
                console.error("Error:", error);
                alert("Error: " + error.message);
            }
        }

        function addRemoteUser(user) {
            if (!remoteUsers[user.uid]) {
                remoteUsers[user.uid] = user;

                // ✅ Create Video Element
                const remoteContainer = document.createElement("div");
                remoteContainer.id = `remote-user-${user.uid}`;
                remoteContainer.style.width = "300px";
                remoteContainer.style.height = "200px";
                remoteContainer.style.background = "gray";
                remoteContainer.style.margin = "10px";
                document.getElementById("remote-video-container").appendChild(remoteContainer);

                // ✅ Play Remote Video
                user.videoTrack.play(remoteContainer);
            }
        }

        function removeRemoteUser(uid) {
            delete remoteUsers[uid];
            const remoteContainer = document.getElementById(`remote-user-${uid}`);
            if (remoteContainer) {
                remoteContainer.remove();
            }
        }
    </script>
</body>
</html>
